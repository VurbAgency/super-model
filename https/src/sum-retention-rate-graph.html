<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="sum-lines-graph.html">

<dom-module id="sum-retention-rate-graph">
  <template>
    <style>
       :host {
        display: block;
        padding: 10px;
      }

      sum-lines-graph {
        width: var(--graph-width, 800px);
        height: var(--graph-height, 400px);
      }      
    </style>
      
    <sum-lines-graph       
      graph-data="[[graphData]]"    
      options="[[options]]"
    ></sum-lines-graph>      
  
  </template>
  <script>
    class SumRetentionRateGraph extends Polymer.Element {
      static get is() { return 'sum-retention-rate-graph'; }
      static get properties() {
        return {
          calculated: {
            type: Object
          },
          xAxisLabels: {
            type: Array,
            computed: "_getXAxisLabels(calculated.*)"
          },
          legendLabels: {
            type: Array,
            value: ['Default Retention Percentages']
          },          
          dataToPlot: {
            type: Array,
            computed: "_getDataToPlot(calculated.*)"
          },
          graphData: {
            type: Object,
            value: {}
          },
          options: {
            type: Object,
            value: {
              responsive: true,
              title:{
                display:true,
                text:"Default Retention"
              },                                
              scales: {
                xAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: 'Month'
                  }
                }],
                yAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: 'Default Retention Percentages'
                  }
                }]
              }
            }
          },
          rgbColors: {
            type: Object,
            value: {red: 100, green: 120, blue: 20} 
          },
        };
      }     
      constructor() {
        super();
      }       

      static get observers() {
        return [
          '_handleGraphParametersChanged(dataToPlot.*, xAxisLabels.*, legendLabels.*, rgbColors.*)',
        ];
      }

      _handleGraphParametersChanged(dataChanged, xAxislabelsChanged, legendLabels, rgbColorsChanged) {
        var data = dataChanged.base;
        var rgbColors = this.rgbColors;
        if(!data || data.length==0 || !rgbColors) return;

        var datasets = [{ 
            label: this.legendLabels[0], 
            data: data,
            backgroundColor: "rgba(" + rgbColors.red  +", " + rgbColors.green + ", " + rgbColors.blue + ",0.2)",
            borderColor: "rgba(" + rgbColors.red  +", " + rgbColors.green + ", " + rgbColors.blue + ",1)",
            borderWidth: 1,
            pointBackgroundColor: "rgba(" + rgbColors.red  +", " + rgbColors.green + ", " + rgbColors.blue + ",1)",
            pointBorderColor: "#fff",
            pointHoverBackgroundColor: "#fff",
            pointHoverBorderColor: "rgba(" + rgbColors.red + ", " + rgbColors.green + ", " + rgbColors.blue + ",1)"
        }];  
        
        this.set('graphData.datasets', datasets)
        this.set('graphData.labels', this.xAxisLabels)
      }

      _getDataToPlot(calculatedChanged) {
        var calculated = calculatedChanged.base;
        var defaultRetentionPercentages = calculated.defaultRetentionPercentages;
        if (isNaN(defaultRetentionPercentages[0]) == true) return [];
        return defaultRetentionPercentages;
      }

      _getXAxisLabels(calculatedChanged) {
        var calculated = calculatedChanged.base;
        var defaultRetentionPercentages = calculated.defaultRetentionPercentages;
        if (defaultRetentionPercentages.length == 0) return [];

        var labels = ['month 2'];
        for (var i = 0; i < defaultRetentionPercentages.length; i++) {
          if(i>0) labels.push('month ' + (i+2).toString())
        }
        return labels;
      }  
    }

    window.customElements.define(SumRetentionRateGraph.is, SumRetentionRateGraph);
  </script>
</dom-module>
